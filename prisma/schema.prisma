generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Kullanıcı sistemi
model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  password     String
  displayName  String?   @map("display_name")
  role         String    @default("user") // "superadmin" veya "user"
  isActive     Boolean   @default(true) @map("is_active")      // Hesap aktif mi?
  isBanned     Boolean   @default(false) @map("is_banned")     // Kullanıcı banlandı mı?
  bannedAt     DateTime? @map("banned_at")                      // Ban tarihi
  bannedReason String?   @map("banned_reason")                  // Ban sebebi
  botEnabled   Boolean   @default(false) @map("bot_enabled")   // Bot bu kullanıcı için aktif mi? (varsayılan KAPALI)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // İlişkiler
  channels   UserChannel[]
  adminLinks AdminLink[]

  @@map("users")
}

// Kullanıcı-Kanal ilişkisi
model UserChannel {
  id        Int     @id @default(autoincrement())
  userId    Int     @map("user_id")
  channelId BigInt  @map("channel_id")
  paused    Boolean @default(true)  // Varsayılan KAPALI - kullanıcı açmalı

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [channelId], onDelete: Cascade)

  @@unique([userId, channelId])
  @@map("user_channels")
}

// Kanallar (hedef kanallar)
model Channel {
  channelId   BigInt   @id @map("channel_id")
  channelName String?  @map("channel_name")
  isJoined    Boolean  @default(false) @map("is_joined")  // Bot bu kanala katıldı mı?
  joinError   String?  @map("join_error")                  // Katılım hatası varsa
  createdAt   DateTime @default(now()) @map("created_at")

  userChannels UserChannel[]
  stats        ChannelStats[]

  @@map("channels")
}

// Dinleme kanalları - her zaman aktif, is_active ayarı yok
model ListeningChannel {
  channelId   BigInt   @id @map("channel_id")
  channelName String?  @map("channel_name")
  defaultLink String   @default("https://example.com") @map("default_link")
  keyword     String   @default("")
  type        String   @default("text")
  triggers    String   @default("")

  @@map("listening_channels")
}

// Admin linkleri (kullanıcı bazlı link özelleştirme)
model AdminLink {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  channelId BigInt   @map("channel_id")
  linkCode  String   @map("link_code")
  linkUrl   String   @map("link_url")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId, linkCode])
  @@map("admin_links")
}

// Kanal istatistikleri
model ChannelStats {
  id          Int      @id @default(autoincrement())
  channelId   BigInt   @map("channel_id")
  statDate    DateTime @map("stat_date") @db.Date
  dailyCount  Int      @default(0) @map("daily_count")
  codeList    String   @default("") @map("code_list")
  lastUpdated DateTime @default(now()) @map("last_updated")

  channel Channel @relation(fields: [channelId], references: [channelId], onDelete: Cascade)

  @@unique([channelId, statDate])
  @@map("channel_stats")
}

// Gönderilmiş kodlar (1 saat cache)
model SentCode {
  code   String   @id
  sentAt DateTime @default(now()) @map("sent_at")

  @@map("sent_codes")
}

// Katılınan kanallar
model JoinedChannel {
  channelId BigInt   @id @map("channel_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  @@map("joined_channels")
}

// Anahtar kelimeler
model Keyword {
  id      Int    @id @default(autoincrement())
  keyword String @unique

  @@map("keywords")
}

// Yasak kelimeler
model BannedWord {
  id   Int    @id @default(autoincrement())
  word String @unique

  @@map("banned_words")
}

// Bot durumu ve logları
model BotStatus {
  id          Int      @id @default(autoincrement())
  isRunning   Boolean  @default(false) @map("is_running")
  lastPing    DateTime? @map("last_ping")
  lastError   String?  @map("last_error")
  startedAt   DateTime? @map("started_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("bot_status")
}

// Bot logları
model BotLog {
  id        Int      @id @default(autoincrement())
  level     String   @default("info") // info, warning, error
  message   String
  details   String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("bot_logs")
}
